# Panduan Konfigurasi Staging & Production
Guide ini berisi langkah-langkah yang harus dilakukan saat memindahkan aplikasi DOORS ke environment Staging atau Production.

## 1. Environment Variables (.env)
Saat di server production, **JANGAN** gunakan file `.env` dari local. Buat file `.env` baru atau copy dari `.env.example` dan sesuaikan nilainya:

| Variable | Local (Development) | Production / Staging | Catatan |
|----------|----------------------|----------------------|---------|
| `APP_ENV` | `local` | `production` | Penting untuk keamanan & performa |
| `APP_DEBUG` | `true` | `false` | **WAJIB FALSE** agar error tidak bocor ke user |
| `APP_URL` | `http://localhost` | `https://doors.dharmagroup.co.id` | Sesuaikan dengan domain asli |
| `DB_HOST` | `127.0.0.1` | `IP_Database_Server` | IP server database production |
| `DB_PASSWORD` | (kosong/root) | (password_kuat) | Password database production |
| `EMPLOYEE_API_KEY` | (key_dev) | (key_production) | Key API untuk data karyawan asli |
| `EMPLOYEE_API_URL` | (url_dev) | (url_production) | URL API production jika beda |

## 2. Perubahan Kode (Wajib Diperbaiki!)

### a. Hapus Bypass SSL di EmployeeApiService
Di local, kita menggunakan `withoutVerifying()` karena masalah sertifikat di laptop. **Di Production, ini BERBAHAYA dan harus dihapus.**

**File:** `app/Services/EmployeeApiService.php` (Baris 31)

**Ubah dari:**
```php
$response = Http::withoutVerifying()->withHeaders([
    'x-api-key' => $this->apiKey
])->get($this->apiUrl, ['company' => 'dpm']);
```

**Menjadi:**
```php
$response = Http::withHeaders([
    'x-api-key' => $this->apiKey
])->get($this->apiUrl, ['company' => 'dpm']);
```

### b. Force HTTPS (Opsional tapi Disarankan)
Jika aplikasi berada di belakang Load Balancer atau Proxy (seperti Nginx), kadang link asset terbaca `http`. Tambahkan ini di `AppServiceProvider.php` method `boot()` jika diperlukan:

```php
use Illuminate\Support\Facades\URL;

public function boot(): void
{
    Paginator::useTailwind();
    if($this->app->environment('production')) {
        URL::forceScheme('https');
    }
}
```

## 3. Command yang Harus Dijalankan di Terminal Server

Setelah code di-upload ke server:

1. **Install Dependency (PHP & JS)**
   ```bash
   composer install --optimize-autoloader --no-dev
   npm install && npm run build
   ```

2. **Setup Aplikasi**
   ```bash
   php artisan key:generate     # Jika env baru
   php artisan storage:link     # Agar gambar bisa diakses
   php artisan migrate --force  # Update database schema
   ```

3. **Optimasi (Wajib untuk performa!)**
   ```bash
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```
   *Catatan: Setiap kali ubah .env di server, JALANKAN perintah ini lagi.*

## 4. Setup Server (Nginx/Apache)

Pastikan root folder mengarah ke folder **`public/`**, bukan root project.
Contoh Nginx Config:
```nginx
root /var/www/doors/public;
index index.php index.html index.htm;
```

## 5. Troubleshooting Umum

**Masalah: Gambar tidak muncul (404)**
- Cek apakah `php artisan storage:link` sudah dijalankan?
- Cek permission folder `storage` dan `bootstrap/cache`. Harus bisa ditulis oleh webserver (`www-data`).
  ```bash
  chmod -R 775 storage bootstrap/cache
  chown -R www-data:www-data storage bootstrap/cache
  ```

**Masalah: Error "500 Server Error"**
- Cek log di `storage/logs/laravel.log`.
- Pastikan `.env` sudah benar (DB password, APP_KEY).
- Coba jalankan `php artisan config:clear`.

**Masalah: Sync Karyawan Gagal (SSL Error)**
- Pastikan server production memiliki sertifikat CA yang valid.
- Jika API menggunakan Self-Signed Certificate, minta tim IT server untuk install sertifikat tersebut di server aplikasi.

## 6. Scheduler (Otomatisasi Sync)
Agar data karyawan selalu update, pasang Cron Job di server agar menjalankan scheduler Laravel setiap menit:

```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```
Ini akan otomatis menjalankan `sync:employees` (jika nanti kita set jadwalnya di `Console/Kernel.php` atau commandnya).
